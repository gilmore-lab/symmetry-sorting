---
title: "Kohler et al. data analysis"
author: "Peter Kohler and Rick Gilmore"
date: "`r Sys.time()`"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3
    toc_float: no
---

# Purpose

This document summarizes and reproduces the data analyses and figures in Kohler, Vedak, and Gilmore.

# Set-up

We specify some parameters and source external dependencies

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = "figures/",
  dev = "pdf",
  dpi = 300,
  fig.align = "center",
  fig.width = 7,
  fig.height = 5
)

library(tidyverse)
library(lmerTest)
library(tidygraph)
library(ggraph)
```

# Number of sets

## Import data

The N sets data are found in `data/nsets.csv`.

```{r}
nsets <- readr::read_csv("data/nsets.csv")
```

There are $n=$ `r length(unique(nsets$Participant))` individual participants.

## Visualize

Create a data frame with the number of sets per participant and wallpaper group.

```{r}
nsets_participant_df <- nsets %>%
  dplyr::group_by(., Participant, Group) %>%
  dplyr::summarise(., nsets_per = n())
```

```{r}
xtabs(~ Participant + Group, data = nsets_participant_df)
```

We are missing data for P6M for one participant.

### Figure 3

```{r, nsets-boxplot, fig.cap="Figure 3. Boxplots showing the number of subsets generated by participants for each of the wallpaper groups. The lower box boundary is the 25th percentile. The dark line in the box is the median. The upper box boundary is the 75th percentile. The 'whiskers' show -/+ the interquartile range * 1.5."}
nsets_boxplot <- nsets_participant_df %>%
  ggplot(.) +
  aes(x = nsets_per, fill = Group) +
  geom_boxplot() +
  facet_grid(Group ~ .) +
  xlab("N sets") +
  scale_y_continuous(NULL, breaks = NULL) +
  theme_classic() +
  theme(legend.position="none") 
nsets_boxplot
```

## Linear mixed effects model

We use linear mixed effects modeling to fit a model to predict the number of sets participants sorted wallpaper group exemplars into as a function of wallpaper group. We estimate a fixed effect for wallpaper group and a random intercept for each participant. 

```{r}
n_sets_lme <- lmer(nsets_per ~ Group + (1 | Participant), data = nsets_participant_df)
summary(n_sets_lme)
```

```{r}
(aov_vals <- anova(n_sets_lme))
```

Compare individual means.

```{r}
(em_n_sets <- emmeans::emmeans(n_sets_lme, "Group"))
summary(pairs(em_n_sets, simple = "Group", adjust = "bonferroni"))
```

### Tabular summary with effect sizes

```{r}
n_sets_stats_df <- as_tibble(pairs(em_n_sets, simple = "Group", adjust = "bonferroni"))
n_sets_stats_df <- n_sets_stats_df %>%
  dplyr::select(., contrast, estimate, t.ratio, df, p.value) %>%
  dplyr::rename(., mean_diff = estimate)

n_sets_es_df <- as_tibble(emmeans::eff_size(em_n_sets, sigma = sigma(n_sets_lme), edf =df.residual(n_sets_lme)))

n_sets_stats_merged_df <- dplyr::full_join(n_sets_stats_df, n_sets_es_df, by=c("contrast")) 

n_sets_stats_merged_df %>%
  dplyr::select(., contrast, t.ratio, p.value, df.x, effect.size) %>%
  knitr::kable(., format = 'html') %>%
  kableExtra::kable_material()
```

# Jaccard index

## Import data

The Jaccard index data are found in `data/jaccard.csv`.

```{r}
jaccard_df <- readr::read_csv("data/jaccard.csv", show_col_types = FALSE)
```

## Visualize

### Figure 4

```{r, jaccard-boxplot, fig.cap="Figure 4. Boxplots showing Jaccard indices for every pairwise combination of exemplars in each of the wallpaper groups. Note that each data point here is the Jaccard index for a particular exemplar pair calculated across participants, unlike Figure 3 were each data point is a participant. The box boundary and whiskers follow the same logic as in Figure 3. The exemplar pairs with the highest Jaccard indices have been highlighted with stars. Those outlier pairs are explored further in Figure 6."}
jaccard_boxplot <- jaccard_df %>%
  dplyr::rename(., `Jaccard Index` = Jaccard) %>%
  ggplot(.) +
  aes(x = `Jaccard Index`, fill = Group) +
  geom_boxplot() +
  facet_grid(Group ~ .) +
  scale_y_continuous(NULL, breaks = NULL) +
  theme_classic() +
  theme(legend.position="none") 

jaccard_boxplot
```

## Linear modeling

There are no random effects in this model.

```{r}
jaccard_lm <- lm(Jaccard ~ Group, data = jaccard_df)
summary(jaccard_lm)
anova(jaccard_lm)
```

```{r}
(em_jaccard <- emmeans::emmeans(jaccard_lm, "Group"))
summary(pairs(em_jaccard, simple = "Group", adjust = "bonferroni"))
```

### Tabular summary with effect sizes

```{r}
jaccard_stats_df <- as_tibble(pairs(em_jaccard, simple = "Group", adjust = "bonferroni"))

jaccard_stats_df <- jaccard_stats_df %>%
  dplyr::select(., contrast, estimate, t.ratio, df, p.value) %>%
  dplyr::rename(., mean_diff = estimate)

jaccard_es_df <- as_tibble(emmeans::eff_size(em_jaccard, sigma = sigma(jaccard_lm), edf =df.residual(jaccard_lm)))

jaccard_stats_merged_df <- dplyr::full_join(jaccard_stats_df, jaccard_es_df, by=c("contrast")) 

jaccard_stats_merged_df %>%
  dplyr::select(., contrast, t.ratio, p.value, df.x, effect.size) %>%
  knitr::kable(., format = 'html') %>%
  kableExtra::kable_material()
```

# Further visualizations

We combine Figures 3 and 4 from the submitted manuscript into a single figure.

```{r nsets-jaccard-plot-combined}
gridExtra::grid.arrange(nsets_boxplot, jaccard_boxplot, nrow = 1)
```


# Jaccard index bootstrapping

The goal is to explore ways to generate an empirical "null" distribution of the Jaccard index data to compare it to the observed data.

**Note**: We set `eval=FALSE` for a series of chunks below that generate the permuted sorting and Jaccard index data. These take many minutes to run.

## Analysis plan

1. Start with each participant's raw sorting data within each wallpaper group.
2. Permute the *exemplars* each participant sorted into similar piles by randomizing the mapping between the actual exemplar and the permuted exemplar id.
  - For example, start with data in `/analysis/data/{P1,P31M,P3M1,P6,P6M}-sorting.csv` and create new CSVs with the permuted values.
  - As a practical matter, this can simply involve permuting the column data in these CSVs.
3. Recalculate the Jaccard indices using the `analysis/make.jaccard.df.R` function.
4. Do 1-3 `n` times, where `n` is large, probably 1,000.
5. Compare the mean Jaccard indices (by wallpaper group) from the permuted set to the values we observed empirically.

## Preliminary work

Build and test a permutation function for the raw sorting data.

Now, let's generate multiple permuted CSVs.

```{r generate_n_sorting_permutations}
generate_n_sorting_permutations <-
  function(wp_group = "P1",
           n_permutations = 5) {
    csv_in <- paste0("data/", wp_group, "-sorting.csv")
    if (!file.exists(csv_in)) {
      stop(paste0("`csv_in` not found: ", csv_in))
    }
    
    df_in <- readr::read_csv(csv_in)
    
    df_exemplars <- df_in[, -c(1, 2, 23, 24)]
    out_m <- as.matrix(df_exemplars)
    for (p in 1:n_permutations) {
      csv_out <-
        paste0(
          "data/permutation_analysis/sorting_csv/",
          wp_group,
          "-sorting-perm-",
          stringr::str_pad(p, 3, pad = 0), ".csv"
        )
      
      for (r in 1:dim(out_m)[1]) {
        new_i <- sample(1:20)
        out_m[r, 1:20] <- out_m[r, new_i]
      }
      
      array_out <-
        as.data.frame(cbind(df_in$Participant, df_in$Set, out_m, df_in$Set_size, df_in$Group))
      
      # Rename!
      names(array_out) <-
        c("Participant",
          "Set",
          names(df_exemplars),
          "Set_size",
          "Group")
      array_out
    
      readr::write_csv(array_out, csv_out)
    }
  }
```

Then test it.

```{r}
generate_n_sorting_permutations()
```

Confirm that we can calculate Jaccard indices from these data.

```{r make_jaccard_csvs}
make_jaccard_csvs <- function(wallpaper_group = "P1",
                              duplicates = FALSE,
                              input_dir = 'permutation_analysis/sorting_csv/',
                              output_dir = 'permutation_analysis/jaccards/') {
  # Makes a data.frame from the raw sorting data
  
  # Load externals
  source("analysis/jaccard.data.R")
  source("analysis/jaccard.R")
  
  these_csvs <-
    list.files(input_dir, paste0("^", wallpaper_group, "\\-"), full.names = TRUE)
  purrr::map(these_csvs,
             calculate_save_jaccard_df,
             wallpaper_group,
             jaccard_dir = output_dir)
}

# Load a sorting permutation file, calculate the Jaccard indices, and (conditionally) save it to file.
calculate_save_jaccard_df <- function(this_csv,
                                      wallpaper_group,
                                      save_output = TRUE,
                                      jaccard_dir = "permutation_analysis/jaccards/",
                                      vb = FALSE) {
  
  this_fn <- basename(this_csv)
  this_perm_number <- stringr::str_extract(this_fn, "[0-9]{3}")
  out_fn <-
    paste0(jaccard_dir,
           wallpaper_group,
           "-jaccard-",
           this_perm_number,
           ".csv")
  
  this_df <- readr::read_csv(this_csv)
  
  # Calculate Jaccard
  jaccard_df <- jaccard.data(this_df)
  
  if (save_output) {
    if (vb) message(paste0('Saving ', out_fn))
    readr::write_csv(jaccard_df, out_fn)
  } else {
    jaccard_df
  }
}
```

```{r, eval=FALSE}
make_jaccard_csvs()
```

## Generate data

### P1

```{r, eval=FALSE}
generate_n_sorting_permutations("P1", n_permutations = 999)
```

```{r, eval=FALSE}
make_jaccard_csvs("P1")
```

### P31M

```{r, eval=FALSE}
generate_n_sorting_permutations("P31M", n_permutations = 999)
```

```{r, eval=FALSE}
make_jaccard_csvs("P31M")
```

### P3M1

```{r, eval=FALSE}
generate_n_sorting_permutations("P3M1", n_permutations = 999)
```

```{r, eval=FALSE}
make_jaccard_csvs("P3M1")
```

### P6

```{r, eval=FALSE}
generate_n_sorting_permutations("P6", n_permutations = 999)
```

```{r, eval=FALSE}
make_jaccard_csvs("P6")
```

### P6M

```{r, eval=FALSE}
generate_n_sorting_permutations("P6M", n_permutations = 999)
```

```{r, eval=FALSE}
make_jaccard_csvs("P6M")
```

## Analyze simulated results

### Create helper functions

```{r make_perm_jaccard_df}
make_perm_jaccard_df <- function(this_csv) {
  this_fn <- basename(this_csv)
  this_perm_number <- stringr::str_extract(this_fn, "[0-9]{3}")
  this_df <- readr::read_csv(this_csv)
  
  this_df <- this_df %>%
    dplyr::mutate(
      .,
      exemplar_pair = paste0(
        stringr::str_extract(Exemplar.Row, "[0-9]{3}$"),
        "-",
        stringr::str_extract(Exemplar.Col, "[0-9]{3}$")
        ),
        perm = this_perm_number
    )
  
  this_df
}
```

```{r make_aggregate_perm_jaccard_df}
make_aggregate_perm_jaccard_df <- function(wp_group = "P1",
                                           input_dir = "adata/permutation_analysis/jaccards",
                                           save_csv = TRUE,
                                           output_dir = "data/permutation_analysis/aggregates",
                                           vb = TRUE) {
  these_csvs <-
    list.files(input_dir, paste0("^", wp_group, "\\-"), full.names = TRUE)
  df <- purrr::map_df(these_csvs, make_perm_jaccard_df)
  
  if (save_csv) {
    out_fn <- file.path(output_dir, paste0(wp_group, "-aggregate-perm-jaccard.csv"))
    if (vb) message(paste0("Saving ", out_fn))
    readr::write_csv(df, out_fn)
  } else {
    df
  }
}
```

### Empirical distributions of Jaccard indices by group and exemplar-pair

### P1

Import the data.

```{r make-P1-perm, eval=FALSE}
P1_perm_df <- make_aggregate_perm_jaccard_df("P1")
```

```{r open-P1-perm}
P1_perm_df <- readr::read_csv("data/permutation_analysis/aggregates/P1-aggregate-perm-jaccard.csv")
```

Visualize.

```{r p1-perm-jaccard-hist}
P1_perm_df %>%
  ggplot2::ggplot(.) +
  ggplot2::aes(x = Jaccard) +
  ggplot2::geom_histogram(bins = 50)
```

Generate summary stats by exemplar pair.

```{r}
P1_perm_stats_df <- P1_perm_df %>%
  dplyr::group_by(., Group, exemplar_pair) %>%
  dplyr::summarize(., jaccard_mean = mean(Jaccard),
                   jaccard_sd = sd(Jaccard))
```

### P31M

Import the data.

```{r make-P31M-perm, eval=FALSE}
P31M_perm_df <- make_aggregate_perm_jaccard_df("P31M")
```

```{r open-P31M-perm}
P31M_perm_df <- readr::read_csv("data/permutation_analysis/aggregates/P31M-aggregate-perm-jaccard.csv")
```

Visualize.

```{r p31m-perm-jaccard-hist}
P31M_perm_df %>%
  ggplot2::ggplot(.) +
  ggplot2::aes(x = Jaccard) +
  ggplot2::geom_histogram(bins = 50)
```

Generate summary stats by exemplar pair.

```{r}
P31M_perm_stats_df <- P31M_perm_df %>%
  dplyr::group_by(., Group, exemplar_pair) %>%
  dplyr::summarize(., jaccard_mean = mean(Jaccard),
                   jaccard_sd = sd(Jaccard))
```

### P3M1

Import the data.

```{r make-P3M1-perm, eval=FALSE}
P3M1_perm_df <- make_aggregate_perm_jaccard_df("P3M1")
```

```{r open-P3M1-perm}
P3M1_perm_df <- readr::read_csv("data/permutation_analysis/aggregates/P3M1-aggregate-perm-jaccard.csv")
```

Visualize.

```{r p3m1-perm-jaccard-hist}
P3M1_perm_df %>%
  ggplot2::ggplot(.) +
  ggplot2::aes(x = Jaccard) +
  ggplot2::geom_histogram(bins = 50)
```

Generate summary stats by exemplar pair.

```{r}
P3M1_perm_stats_df <- P3M1_perm_df %>%
  dplyr::group_by(., Group, exemplar_pair) %>%
  dplyr::summarize(., jaccard_mean = mean(Jaccard),
                   jaccard_sd = sd(Jaccard))
```

### P6

Import the data.

```{r make-P6-perm, eval=FALSE}
P6_perm_df <- make_aggregate_perm_jaccard_df("P6")
```

```{r open-P6-perm}
P6_perm_df <- readr::read_csv("data/permutation_analysis/aggregates/P6-aggregate-perm-jaccard.csv")
```

Visualize.

```{r p6-perm-jaccard-hist}
P6_perm_df %>%
  ggplot2::ggplot(.) +
  ggplot2::aes(x = Jaccard) +
  ggplot2::geom_histogram(bins = 50)
```

Generate summary stats by exemplar pair.

```{r}
P6_perm_stats_df <- P6_perm_df %>%
  dplyr::group_by(., Group, exemplar_pair) %>%
  dplyr::summarize(., jaccard_mean = mean(Jaccard),
                   jaccard_sd = sd(Jaccard))
```

### P6M

Import the data.

```{r make-P6M-perm, eval=FALSE}
P6M_perm_df <- make_aggregate_perm_jaccard_df("P6M")
```

```{r open-P6M-perm}
P6M_perm_df <- readr::read_csv("data/permutation_analysis/aggregates/P6M-aggregate-perm-jaccard.csv")
```

Visualize.

```{r p6m-perm-jaccard-hist}
P6M_perm_df %>%
  ggplot2::ggplot(.) +
  ggplot2::aes(x = Jaccard) +
  ggplot2::geom_histogram(bins = 50)
```

Generate summary stats by exemplar pair.

```{r}
P6M_perm_stats_df <- P6M_perm_df %>%
  dplyr::group_by(., Group, exemplar_pair) %>%
  dplyr::summarize(., jaccard_mean = mean(Jaccard),
                   jaccard_sd = sd(Jaccard))
```

### Aggregating across groups

```{r}
jaccard_perm_df <- rbind(P1_perm_df, P31M_perm_df, P3M1_perm_df, P6_perm_df, P6M_perm_df)
```

Visualization.

```{r agg-perm-jaccard-histogram}
jaccard_perm_df %>%
  ggplot(.) +
  aes(Jaccard, color = Group) +
  facet_grid(Group ~ .) +
  geom_boxplot(bins = 50)
```

```{r agg-perm-jaccard-boxplot}
jaccard_perm_df %>%
  ggplot(.) +
  aes(Jaccard, color = Group) +
  facet_grid(Group ~ .) +
  geom_boxplot(bins = 50)
```

```{r agg-perm-jaccard-violin}
jaccard_perm_df %>%
  ggplot(.) +
  aes(x = Group, y = Jaccard) +
  geom_violin()
```

These plots show that the mean differences in Jaccard indices are reflected in the participants' data are shown in the permuted data, too. This makes sense since the participants detected regularities and sorted the exemplars into different numbers of sets. In permuting the exemplar identifiers within participants, we keep some of this structure.

Let's try aggregating the by-exemplar statistics.

```{r}
jaccard_perm_stats_df <- rbind(P1_perm_stats_df, P31M_perm_stats_df, P3M1_perm_stats_df, P6_perm_stats_df, P6M_perm_stats_df)

# Sort by group, exemplar_pair
jaccard_perm_stats_df <- jaccard_perm_stats_df %>%
  dplyr::arrange(Group, exemplar_pair)
```

```{r agg-mean-jaccard-hist}
jaccard_perm_stats_df %>%
  ggplot(.) +
  aes(x = jaccard_mean, fill = Group) +
  geom_histogram() +
  facet_grid(Group ~ .) + 
  ggtitle("Mean exemplar-pair Jaccard indices for permuted data")
```

```{r agg-sd-jaccard-hist}
jaccard_perm_stats_df %>%
  ggplot(.) +
  aes(x = jaccard_sd, fill = Group) +
  geom_histogram() +
  facet_grid(Group ~ .) +
  ggtitle("Standard deviation of exemplar-pair Jaccard indices for permuted data")
```

## Compare observed Jaccard to empirical distribution

Load the observed data and clean it.

```{r}
jaccard_observed_df <-
  readr::read_csv("data/jaccard-no-duplicates.csv")

jaccard_observed_df <- jaccard_observed_df %>%
  dplyr::mutate(.,
                exemplar_pair = paste0(
                  stringr::str_extract(Exemplar.Row, "[0-9]{3}$"),
                  "-",
                  stringr::str_extract(Exemplar.Col, "[0-9]{3}$")
                )) %>%
  dplyr::arrange(., Group, exemplar_pair)
```

Now, merge the permuted data with the observed data.

```{r}
jaccard_merged_df <- dplyr::left_join(jaccard_perm_stats_df,
                                      jaccard_observed_df,
                                      by = c("Group", "exemplar_pair"))

# Rearrange columns for convenience
jaccard_merged_df <- jaccard_merged_df %>%
  dplyr::select(., Group, exemplar_pair, Jaccard, jaccard_mean, jaccard_sd, Exemplar.Row, Exemplar.Col)

# Rename variables for clarity
jaccard_merged_df <- jaccard_merged_df %>%
  dplyr::rename(., group = Group, jaccard_obs = Jaccard, 
                jaccard_emp_mean = jaccard_mean,
                jaccard_emp_sd = jaccard_sd,
                exemplar_row = Exemplar.Row,
                exemplar_col = Exemplar.Col)
```

Calculate empirical z as $z_{emp}=J_{obs}-\mu_{J}$ for each exemplar pair.

```{r}
jaccard_merged_df <- jaccard_merged_df %>%
  dplyr::mutate(., z_emp = (jaccard_obs-jaccard_emp_mean)/jaccard_emp_sd,
                p_z_emp = pnorm(z_emp, jaccard_emp_mean, jaccard_emp_sd, lower.tail = FALSE))
```

Plot a histogram of `z_emp`.

```{r jaccard-emp-z-hist}
jaccard_merged_df %>%
  ggplot(.) +
  aes(z_emp, fill = group) +
  geom_histogram() +
  facet_grid(group ~ .)
```

Curiously, P31M, P6, P6M and P3M1 have exemplar pairs whose observed Jaccard indices are substantially larger than the empirically derived reference (null) distribution even though the mean Jaccard indices for P1 are the largest.

Just for fun, let's print the exemplar pairs whose `z_emp` exceeds some criterion $z$ values.

We'll use a two-tailed criterion value.

### $z_{obs}>$ `r (z_crit <- qnorm(p = 1-.5*(.0001)))`, $p<.0001$

```{r}
p_crit <- .0001
z_crit <- qnorm(p = 1-.5*(p_crit))
    
j_emp_p0001 <- jaccard_merged_df %>%
  dplyr::filter(., z_emp > z_crit) %>%
  dplyr::arrange(., group, desc(jaccard_emp_mean)) 

knitr::kable(j_emp_p0001)
```


```{r}
xtabs(~ group, j_emp_p0001)
```

#### Observations

For P31M, 014 (4 pairs), 020 (3 pairs), and 002 (3 pairs) are sorted together. For P3M1, 019 (2 pairs); for P6, 014 (2 pairs), 013 (2 pairs), 008 (2 pairs), 006 (2 pairs), 017 (2 pairs), 019 (2 pairs); For P6M, 008 (2 pairs), 010 (2 pairs), 020 (2 pairs).

### $z_{obs}>$ `r (z_crit <- qnorm(p = 1-.5*(.001)))`, $p<.001$

```{r}
p_crit <- .001
z_crit <- qnorm(p = 1-.5*(p_crit))
                
j_emp_p001 <- jaccard_merged_df %>%
  dplyr::filter(., z_emp > z_crit) %>%
  dplyr::arrange(., group, desc(jaccard_emp_mean))

knitr::kable(j_emp_p001)
```

```{r}
xtabs(~ group, j_emp_p001)
```

### $z_{obs}>$ `r (z_crit <- qnorm(p = 1-.5*(.01)))`, $p<.01$

```{r}
p_crit <- .01
z_crit <- qnorm(p = 1-.5*(p_crit))

j_emp_p01 <- jaccard_merged_df %>%
  dplyr::filter(., z_emp > z_crit) %>%
  dplyr::arrange(., group, desc(jaccard_emp_mean))

knitr::kable(j_emp_p01)
```

```{r}
xtabs(~ group, j_emp_p01)
```

### $z_{obs}>$ `r (z_crit <- qnorm(p = 1-.5*(.05)))`, $p<.05$

```{r}
p_crit <- .05
z_crit <- qnorm(p = 1-.5*(p_crit))

j_emp_p05 <- jaccard_merged_df %>%
  dplyr::filter(., z_emp > z_crit) %>%
  dplyr::arrange(., group, desc(jaccard_emp_mean))

knitr::kable(j_emp_p05)
```

```{r}
xtabs(~ group, j_emp_p05)
```

### Histogram with annotations

```{r, emp-jaccard-histogram-w-annotations}
jaccard_merged_df %>%
  ggplot(.) +
  aes(x = z_emp, fill = group) +
  geom_histogram(bins = 20) +
  geom_vline(xintercept = qnorm(1-.5*(.0001)), color = "black") +
  geom_vline(xintercept = qnorm(1-.5*(.01)), color = "black", alpha = 0.45) +
  ylab(element_blank()) +
  xlab("Z score") +
  annotate("text", x = 4.6, y = 50, label = "p=0.0001", size = 2.5) +
  annotate("text", x = 3.1, y = 50, label = "p=0.01", size = 2.5) +
  facet_grid(group ~ .) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks.y = element_blank()) +
  theme(legend.position="none") +
  theme_classic()
```
Distribution of $z$ scores of observed Jaccard values for all exemplar pairs relative to simulated permuted values for each of the five wallpaper groups. Vertical bars indicate the two-tailed $z$ values that represent $p=.01$ or $z=$ `r qnorm(1-.5*(.01))` and $p=.0001$ or $z=$ `r qnorm(1-.5*(.0001))`. All wallpaper groups show exemplar pairs with large $z$ scores, with P31M and P6 showing an especially large number of exemplar pairs with extreme values.


# Graph network analysis

## Import data

The Jaccard index data are found in `data/jaccard.csv`.

```{r}
jaccard_raw <- readr::read_csv("data/jaccard.csv")
jaccard <- jaccard_raw %>%
  dplyr::arrange(., Group, Exemplar.Row, desc(Jaccard))
```

## Helper functions to create graph

```{r}
wp_graph <- function(df, group) {
  out_df <- df %>%
    dplyr::filter(., Group == group)

  df_edges <- tibble(from = out_df$Exemplar.Row,
                     to = out_df$Exemplar.Col,
                     weight = out_df$Jaccard)
  
  df_nodes <- tibble(id = 1:20)
 
  tidygraph::tbl_graph(nodes = df_nodes, 
                       edges = df_edges,
                       directed = FALSE)
}


# Create network/graph plot of 
plot_jaccard_vals <- function(df, 
                              exemplar_id, 
                              group, 
                              j_stat_type = "mean", 
                              j_stat_val = NA,
                              show_title = FALSE,
                              show_legend = FALSE
                              ) {
  df <- df %>%
    activate(edges) %>%
    dplyr::filter(., from == exemplar_id | to == exemplar_id) %>%
    dplyr::mutate(weight = cut(weight, c(0, .2, .4, .6, .8), 
                               labels = c("<.2", ".2-.4", ".4-.6", ">.6")))
  
  g <- ggraph(df, layout = "linear", circular = TRUE) +
    geom_edge_arc(aes(color = factor(weight))) +
    geom_node_text(aes(label = id)) +
    scale_edge_color_brewer(palette = "Oranges") +
    theme_graph() + 
    coord_fixed()

  if (show_title) {
    f_stat <- format(j_stat_val, digits = 2, nsmall = 2)
    g <- g + ggtitle(paste0(group, " | # ", exemplar_id, " | ", j_stat_type, " Jaccard ", f_stat))
  }
  if (!show_legend) {
    g <- g + theme(legend.position="none") 
  }
  g
}

# Compute statistics on Jaccard indices by exemplar pair
jaccard_stats <- function(jaccard) {
  jaccard %>%
    dplyr::mutate(., exemplar_pair = paste0(Exemplar.Row, "-", Exemplar.Col)) %>%
    dplyr::group_by(., Group) %>%
    dplyr::summarise(
      .,
      Jaccard_mean = mean(Jaccard),
      Jaccard_med = median(Jaccard),
      Jaccard_max = max(Jaccard),
      Jaccard_min = min(Jaccard),
      Exemplar.Row = Exemplar.Row,
      Exemplar.Col = Exemplar.Col,
      Jaccard = Jaccard,
      exemplar_pair = exemplar_pair
    ) %>%
    dplyr::arrange(., desc(Jaccard_mean))
}
```

Test the functions with P1.

## Plot network graphs

### P1

```{r}
j_stats <- jaccard_stats(jaccard)

p1_g <- wp_graph(jaccard, "P1")

exemplars_w_max_jaccard <- j_stats %>%
  dplyr::filter(., Group == 'P1',
                Jaccard_max == Jaccard)

exemplars_w_min_jaccard <- j_stats %>%
  dplyr::filter(., Group == 'P1',
                Jaccard_min == Jaccard)

```

Plot the network for the exemplar with the maximum Jaccard value.

```{r P1-Max-Jaccard-Exemplar-1}
plot_jaccard_vals(p1_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Row']), 
                  "P1", 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```

Plot the network for the exemplar that is the other member of the maximally connected pair.

```{r P1-Max-Jaccard-Exemplar-2}
plot_jaccard_vals(p1_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Col']), 
                  "P1", 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```


### P6

```{r}
this_g <- "P6"
wp_g <- wp_graph(jaccard, this_g)

exemplars_w_max_jaccard <- j_stats %>%
  dplyr::filter(., Group == this_g,
                Jaccard_max == Jaccard)

exemplars_w_min_jaccard <- j_stats %>%
  dplyr::filter(., Group == this_g,
                Jaccard_min == Jaccard)

```

Plot the network for the exemplar with the maximum Jaccard value.

```{r P6-Max-Jaccard-Exemplar-1}
plot_jaccard_vals(wp_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Row']), 
                  this_g, 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```

Plot the network for the exemplar that is the other member of the maximally connected pair.

```{r P6-Max-Jaccard-Exemplar-2}
plot_jaccard_vals(wp_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Col']), 
                  this_g, 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```

### P3M1

```{r}
this_g <- "P3M1"
wp_g <- wp_graph(jaccard, this_g)

exemplars_w_max_jaccard <- j_stats %>%
  dplyr::filter(., Group == this_g,
                Jaccard_max == Jaccard)

exemplars_w_min_jaccard <- j_stats %>%
  dplyr::filter(., Group == this_g,
                Jaccard_min == Jaccard)

```

Plot the network for the exemplar with the maximum Jaccard value.

```{r P3M1-Max-Jaccard-Exemplar-1}
plot_jaccard_vals(wp_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Row']), 
                  this_g, 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```

Plot the network for the exemplar that is the other member of the maximally connected pair.

```{r P3M1-Max-Jaccard-Exemplar-2}
plot_jaccard_vals(wp_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Col']), 
                  this_g, 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```

### P31M

```{r}
this_g <- "P31M"
wp_g <- wp_graph(jaccard, this_g)

exemplars_w_max_jaccard <- j_stats %>%
  dplyr::filter(., Group == this_g,
                Jaccard_max == Jaccard)

exemplars_w_min_jaccard <- j_stats %>%
  dplyr::filter(., Group == this_g,
                Jaccard_min == Jaccard)

```

Plot the network for the exemplar with the maximum Jaccard value.

```{r P31M-Max-Jaccard-Exemplar-1}
plot_jaccard_vals(wp_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Row']), 
                  this_g, 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```

Plot the network for the exemplar that is the other member of the maximally connected pair.

```{r P31M-Max-Jaccard-Exemplar-2}
plot_jaccard_vals(wp_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Col']), 
                  this_g, 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```



### P6M

```{r}
this_g <- "P6M"
wp_g <- wp_graph(jaccard, this_g)

exemplars_w_max_jaccard <- j_stats %>%
  dplyr::filter(., Group == this_g,
                Jaccard_max == Jaccard)

exemplars_w_min_jaccard <- j_stats %>%
  dplyr::filter(., Group == this_g,
                Jaccard_min == Jaccard)

```

Plot the network for the exemplar with the maximum Jaccard value.

```{r P6M-Max-Jaccard-Exemplar-1}
plot_jaccard_vals(wp_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Row']), 
                  this_g, 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```

Plot the network for the exemplar that is the other member of the maximally connected pair.

```{r P6M-Max-Jaccard-Exemplar-2}
plot_jaccard_vals(wp_g, 
                  as.character(exemplars_w_max_jaccard[1, 'Exemplar.Col']), 
                  this_g, 
                  "max", 
                  as.numeric(exemplars_w_max_jaccard[1, 'Jaccard']))
```



## Plot heatmaps

### Create helper function

Note: Because we are using the `heatmap()` function, the row and column lables are not in the ideal position for our plots. So, we moved them manually in creating the figures in the manuscript.

```{r}
plot_wp_heatmap <- function(df, group) {
  this_df <- df %>%
    dplyr::filter(., Group %in% group)
  
  this_matrix <- matrix(nrow = 20*length(group), ncol = 20)
  
  for (r in 1:190) {
    this_matrix[this_df$Exemplar.Row[r], this_df$Exemplar.Col[r]] <-
      this_df$Jaccard[r]
  }
  
  heatmap(this_matrix, 
          Rowv = NA, 
          Colv = NA, 
          symm = TRUE, 
          main = group,
          col= colorRampPalette(RColorBrewer::brewer.pal(4, "Oranges"))(4))
  
  legend(x="bottomright",
         legend=c("<.2", ".2-.4", ".4-.6", ">.6"),
         fill=colorRampPalette(RColorBrewer::brewer.pal(4, "Oranges"))(4))
}
```

```{r P1-jaccard-heatmap}
plot_wp_heatmap(jaccard, "P1")
```

```{r P6-jaccard-heatmap}
plot_wp_heatmap(jaccard, "P6")
```

```{r P3M1-jaccard-heatmap}
plot_wp_heatmap(jaccard, "P3M1")
```

```{r P31M-jaccard-heatmap}
plot_wp_heatmap(jaccard, "P31M")
```

```{r P6M-jaccard-heatmap}
plot_wp_heatmap(jaccard, "P6M")
```