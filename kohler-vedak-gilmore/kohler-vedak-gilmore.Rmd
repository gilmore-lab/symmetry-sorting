---
title: "Kohler et al. data analysis"
author: "Peter Kohler and Rick Gilmore"
date: "`r Sys.time()`"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3
    toc_float: no
---

# Purpose

This document summarizes and reproduces many of the data analyses described in Kohler, Vedak, and Gilmore.

# Set-up

We specify some parameters and source external dependencies

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = "figures/",
  dev = "pdf",
  dpi = 300,
  fig.align = "center",
  fig.width = 7,
  fig.height = 5
)

library(tidyverse)
library(lmerTest)
```

# Number of sets

## Import data

The N sets data are found in `csv/nsets.csv`.

```{r}
nsets <- readr::read_csv("csv/nsets.csv")
```

There are $n=$ `r length(unique(nsets$Participant))` individual participants.

## Visualize

Create a data frame with the number of sets per participant and wallpaper group.

```{r}
nsets_participant_df <- nsets %>%
  dplyr::group_by(., Participant, Group) %>%
  dplyr::summarise(., nsets_per = n())
```

### Figure 3

```{r, nsets-boxplot, fig.cap="Figure 3. Boxplots showing the number of subsets generated by participants for each of the wallpaper groups. The lower box boundary is the 25th percentile. The dark line in the box is the median. The upper box boundary is the 75th percentile. The 'whiskers' show -/+ the interquartile range * 1.5."}
nsets_boxplot <- nsets_participant_df %>%
  ggplot(.) +
  aes(x = nsets_per, fill = Group) +
  geom_boxplot() +
  facet_grid(Group ~ .) +
  xlab("N sets") +
  scale_y_continuous(NULL, breaks = NULL) +
  theme_classic() +
  theme(legend.position="none") 
nsets_boxplot
```

## Linear mixed effects model

We use linear mixed effects modeling to fit a model to predict the number of sets participants sorted wallpaper group exemplars into as a function of wallpaper group. We estimate a fixed effect for wallpaper group and a random intercept for each participant. 

```{r}
n_sets_lme <- lmer(nsets_per ~ Group + (1 | Participant), data = nsets_participant_df)
summary(n_sets_lme)
```

```{r}
(aov_vals <- anova(n_sets_lme))
```

Compare individual means.

```{r}
(em_n_sets <- emmeans::emmeans(n_sets_lme, "Group"))
summary(pairs(em_n_sets, simple = "Group", adjust = "bonferroni"))
```

### Tabular summary with effect sizes

```{r}
n_sets_stats_df <- as_tibble(pairs(em_n_sets, simple = "Group", adjust = "bonferroni"))
n_sets_stats_df <- n_sets_stats_df %>%
  dplyr::select(., contrast, estimate, t.ratio, df, p.value) %>%
  dplyr::rename(., mean_diff = estimate)

n_sets_es_df <- as_tibble(emmeans::eff_size(em_n_sets, sigma = sigma(n_sets_lme), edf =df.residual(n_sets_lme)))

n_sets_stats_merged_df <- dplyr::full_join(n_sets_stats_df, n_sets_es_df, by=c("contrast")) 

n_sets_stats_merged_df %>%
  dplyr::select(., contrast, t.ratio, p.value, df.x, effect.size) %>%
  knitr::kable(., format = 'html') %>%
  kableExtra::kable_material()
```

# Jaccard index

## Import data

The Jaccard index data are found in `csv/jaccard.csv`.

```{r}
jaccard_df <- readr::read_csv("csv/jaccard.csv")
```

## Visualize

### Figure 4

```{r, jaccard-boxplot, fig.cap="Figure 4. Boxplots showing Jaccard indices for every pairwise combination of exemplars in each of the wallpaper groups. Note that each data point here is the Jaccard index for a particular exemplar pair calculated across participants, unlike Figure 3 were each data point is a participant. The box boundary and whiskers follow the same logic as in Figure 3. The exemplar pairs with the highest Jaccard indices have been highlighted with stars. Those outlier pairs are explored further in Figure 6."}
jaccard_boxplot <- jaccard_df %>%
  dplyr::rename(., `Jaccard Index` = Jaccard) %>%
  ggplot(.) +
  aes(x = `Jaccard Index`, fill = Group) +
  geom_boxplot() +
  facet_grid(Group ~ .) +
  scale_y_continuous(NULL, breaks = NULL) +
  theme_classic() +
  theme(legend.position="none") 
jaccard_boxplot
```

## Linear modeling

There are no random effects in this model.

```{r}
jaccard_lm <- lm(Jaccard ~ Group, data = jaccard_df)
summary(jaccard_lm)
anova(jaccard_lm)
```

```{r}
(em_jaccard <- emmeans::emmeans(jaccard_lm, "Group"))
summary(pairs(em_jaccard, simple = "Group", adjust = "bonferroni"))
```

### Tabular summary with effect sizes

```{r}
jaccard_stats_df <- as_tibble(pairs(em_jaccard, simple = "Group", adjust = "bonferroni"))

jaccard_stats_df <- jaccard_stats_df %>%
  dplyr::select(., contrast, estimate, t.ratio, df, p.value) %>%
  dplyr::rename(., mean_diff = estimate)

jaccard_es_df <- as_tibble(emmeans::eff_size(em_jaccard, sigma = sigma(jaccard_lm), edf =df.residual(jaccard_lm)))

jaccard_stats_merged_df <- dplyr::full_join(jaccard_stats_df, jaccard_es_df, by=c("contrast")) 

jaccard_stats_merged_df %>%
  dplyr::select(., contrast, t.ratio, p.value, df.x, effect.size) %>%
  knitr::kable(., format = 'html') %>%
  kableExtra::kable_material()
```

# Further visualizations

We combine Figures 3 and 4 from the submitted manuscript into a single figure.

```{r nsets-jaccard-plot-combined}
gridExtra::grid.arrange(nsets_boxplot, jaccard_boxplot, nrow = 1)
```

